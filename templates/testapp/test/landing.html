{% extends 'base.html' %}
{% load static %}

{% block content %}
<style>
    nav {
        display: none !important;
    }
</style>
<div class="container py-4">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card bg-transparent border-0">
                <div class="card-body">
                    {% if tests %}
                        {% for test in tests %}
                            <a href="{% url 'testapp:test_start' %}?test_id={{test.id}}" 
                                class="btn btn-primary btn-lg d-block mb-3">
                                <h5 class="text-center m-1">{{ test.subject.name }} {{ test.subject.grade }}-klass <i class="bi bi-check2" id="{{ test.id }}" style="display: none;"></i></h5>
                            </a>
                        {% endfor %}
                    {% else %}
                        <div class="alert alert-warning">
                            Testler tabılmadı!
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>


<script src="https://telegram.org/js/telegram-web-app.js"></script>
<script>
    var testId = '';
    var studentId = ''; 

  function getQueryParam(name) {
    const url = new URL(window.location.href);
    return url.searchParams.get(name);
  }



  window.onload = function () {
    // Telegram Web App API orqali foydalanuvchi ma'lumotlarini olish
    const tg = window.Telegram.WebApp;

    // tests ni URLdan olish
    testIds = getQueryParam('tests') || getQueryParam('tgWebAppStartParam');  // tests = 1A2A3A4A5A6A

    // Foydalanuvchi ma'lumotlarini tekshiramiz
    if (tg && tg.initDataUnsafe && tg.initDataUnsafe.user) {
        const user = tg.initDataUnsafe.user;
        studentId = user.id;
        testids_array = testIds.split('A');
        for (var i = 0; i < testids_array.length; i++) {
            fetch(`/api/check-participation/?student_id=${user.id}&test_id=${testids_array[i]}`)
            .then(response => response.json())
            .then(data => {
                if (data.participated) {
                    // document.getElementById(testids_array[i]).style.display = "inline-block";
                } 
            })
            .catch(error => {
                console.error('Error:', error);
            });
            document.getElementById(testids_array[i]).style.display = "inline-block";
        }

    } else {
      console.warn("Foydalanuvchi ma'lumotlari mavjud emas.");
    }


  };
</script>



{% endblock %}